<div class="container">
  <h1>Favourite & Instant Fares Portal</h1>

  <!-- Button to open the Instant Fare Modal -->
  <div class="top-buttons">
    <button (click)="openInstantFareModal()">Add Instant Fare</button>
    <button (click)="openCreateInstantFareModal()">Create Instant Fare</button>
  </div>

  <!-- Create Instant Fare Modal -->
  <div *ngIf="createInstantFareModalOpen" class="instant-fare-modal">
    <div class="instant-fare-form-card">
      <h3>Create New Instant Fare</h3>

      <mat-form-field appearance="fill">
        <mat-label>Instant Fare Title</mat-label>
        <input matInput [(ngModel)]="newInstantFareTitle" />
      </mat-form-field>

      <div class="button-group">
        <button (click)="createInstantFare()">Save Instant Fare</button>
        <button (click)="closeCreateInstantFareModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Search box with dropdown for selecting search type -->
  <div class="search-box">
    <select [(ngModel)]="searchType" (change)="onSearch()">
      <option value="title">Title</option>
      <option value="id">ID</option>
      <option value="body">Body</option>
    </select>

    <input
      type="text"
      placeholder="Search"
      [(ngModel)]="searchTerm"
      (input)="onSearch()"
      class="search-input"
    />
  </div>

  <table mat-table [dataSource]="filteredPosts" multiTemplateDataRows class="mat-elevation-z8">
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef> ID </th>
      <td mat-cell *matCellDef="let post"> {{ post.id }} </td>
    </ng-container>

    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef> Title </th>
      <td mat-cell *matCellDef="let post">
        <span (click)="toggleExpand(post, $event)" style="cursor: pointer;">
          {{ post.title }}
        </span>
        <div *ngIf="expandedPostIds.has(post.id)" class="expanded-content">
          <p><strong>ID:</strong> {{ post.id }}</p>
          <p><strong>Body:</strong> {{ post.body }}</p>
          <p><strong>Favorites:</strong> {{ getFavoritesTitles(post) }}</p>
          <p><strong>Instant Fares:</strong> {{ getInstantFareTitles(post) }}</p>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let post">
        <button (click)="editPost(post)">Edit</button>
        <button (click)="deletePost(post)">Delete</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
    <tr mat-row *matRowDef="let post; columns: columnsToDisplayWithExpand;" (click)="toggleExpand(post, $event)"></tr>
  </table>

  <!-- Edit Modal -->
  <div *ngIf="editMode" class="edit-modal" (click)="stopRowExpand($event)">
    <div class="edit-form-card" (click)="stopRowExpand($event)">
      <h2>Edit Post</h2>

      <mat-form-field appearance="fill">
        <mat-label>Title</mat-label>
        <input matInput [(ngModel)]="currentPost.title" />
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Body</mat-label>
        <textarea matInput [(ngModel)]="currentPost.body"></textarea>
      </mat-form-field>

      <h3>Add Favorites</h3>
      <mat-form-field appearance="fill">
        <mat-label>Search Favorites</mat-label>
        <input matInput [(ngModel)]="favoriteSearchTerm" (input)="onFavoriteSearch()" />
      </mat-form-field>

      <div *ngIf="alreadyAddedMessage.favorite">{{ alreadyAddedMessage.favorite }}</div>

      <ul>
        <li *ngFor="let ticket of favoriteTickets">
          <button (click)="addTicketToCurrentPost(ticket, 'favorite')">Add {{ ticket.title }}</button>
        </li>
      </ul>

      <h4>Favorites in Post:</h4>
      <ul>
        <li *ngFor="let favorite of currentPost.favorites">
          {{ favorite.title }}
          <button (click)="removeTicketFromCurrentPost(favorite.title, 'favorite')">Remove</button>
        </li>
      </ul>

      <button (click)="savePost()">Save</button>
      <button (click)="cancelEdit()">Cancel</button>
    </div>
  </div>

  <!-- Instant Fare Modal -->
  <div *ngIf="instantFareModalOpen" class="instant-fare-modal">
    <div class="instant-fare-form-card">
      <h3>Add Instant Fare</h3>

      <mat-form-field appearance="fill">
        <mat-label>Search Instant Fares</mat-label>
        <input matInput [(ngModel)]="instantFareSearchTerm" (input)="onInstantFareSearch()" />
      </mat-form-field>

      <ul>
        <li *ngFor="let ticket of instantFareTickets">
          <button (click)="addInstantFareToModal(ticket)">Add {{ ticket.title }}</button>
        </li>
      </ul>

      <h4>Selected Instant Fares:</h4>
      <ul>
        <li *ngFor="let instantFare of selectedInstantFares">
          {{ instantFare.title }}
          <button (click)="removeInstantFareFromAllPosts(instantFare.title)">Remove from All Posts</button>
        </li>
      </ul>

      <button (click)="addSelectedFaresToAllPosts()">Add to All Posts</button>
      <button (click)="closeInstantFareModal()">Close</button>
    </div>
  </div>
</div>
