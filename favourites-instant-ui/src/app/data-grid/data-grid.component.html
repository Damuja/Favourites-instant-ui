<div class="container">
  <h1>Favourite & Instant Fares Portal</h1>

  <div class="search-box">
    <input
      type="text"
      placeholder="Search by title"
      [(ngModel)]="searchTerm"
      (input)="onSearch()"
      class="search-input"
    />
  </div>

  <!--Table -->
  <table mat-table [dataSource]="filteredPosts" multiTemplateDataRows class="mat-elevation-z8">

    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef> ID </th>
      <td mat-cell *matCellDef="let post"> {{ post.id }} </td>
    </ng-container>
    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef> Title </th>
      <td mat-cell *matCellDef="let post">
        <span (click)="toggleExpand(post, $event)" style="cursor: pointer;">
          {{ post.title }}
        </span>
        <div *ngIf="expandedPostIds.has(post.id)" class="expanded-content">
          <p><strong>ID:</strong> {{ post.id }}</p>
          <p><strong>Body:</strong> {{ post.body }}</p>
          <p><strong>Favorites:</strong> {{ getFavoritesTitles(post) }}</p>
          <p><strong>Instant Fares:</strong> {{ getInstantFareTitles(post) }}</p>
        </div>
      </td>
    </ng-container>
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let post">
        <button (click)="editPost(post)">Edit</button>
        <button (click)="deletePost(post)">Delete</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
    <tr mat-row *matRowDef="let post; columns: columnsToDisplayWithExpand;" (click)="toggleExpand(post, $event)"></tr>
  </table>
  <div *ngIf="editMode" class="edit-modal" (click)="stopRowExpand($event)">
    <div class="edit-form-card" (click)="stopRowExpand($event)">
      <h2>Edit Post</h2>

      <mat-form-field appearance="fill">
        <mat-label>Title</mat-label>
        <input matInput [(ngModel)]="currentPost.title" />
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Body</mat-label>
        <textarea matInput [(ngModel)]="currentPost.body"></textarea>
      </mat-form-field>

      <h3>Add Favorites</h3>
      <mat-form-field appearance="fill">
        <mat-label>Search Favorites</mat-label>
        <input matInput [(ngModel)]="favoriteSearchTerm" (input)="onFavoriteSearch()" />
      </mat-form-field>
      <div *ngFor="let ticket of favoriteTickets">
        <p>{{ ticket.title }}</p>
        <button (click)="addTicketToCurrentPost(ticket, 'favorite')">Add to Favorites</button>
      </div>

      <h3>Add Instant Fares</h3>
      <mat-form-field appearance="fill">
        <mat-label>Search Instant Fares</mat-label>
        <input matInput [(ngModel)]="instantFareSearchTerm" (input)="onInstantFareSearch()" />
      </mat-form-field>
      <div *ngFor="let ticket of instantFareTickets">
        <p>{{ ticket.title }}</p>
        <button (click)="addTicketToCurrentPost(ticket, 'instantFare')">Add to Instant Fares</button>
      </div>

      <h3>Current Favorites</h3>
      <div *ngFor="let ticket of currentPost.favorites">
        <p>{{ ticket.title }} <button (click)="removeTicketFromCurrentPost(ticket.title, 'favorite')">Remove</button></p>
      </div>

      <h3>Current Instant Fares</h3>
      <div *ngFor="let ticket of currentPost.instantFares">
        <h2>{{ ticket.title }} <button (click)="removeTicketFromCurrentPost(ticket.title, 'instantFare')">Remove</button></h2>
      </div>

      <button mat-raised-button color="primary" (click)="savePost()">Save</button>
      <button mat-raised-button color="warn" (click)="cancelEdit()">Cancel</button>
    </div>
  </div>
</div>
